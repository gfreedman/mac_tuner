name: Release

on:
  push:
    tags:
      - "v*"

jobs:
  release:
    name: Tag → GitHub Release → Homebrew formula
    runs-on: macos-latest

    steps:
      - name: Checkout mac_tuner
        uses: actions/checkout@v4

      - name: Read version from tag
        id: version
        run: echo "tag=${GITHUB_REF_NAME}" >> "$GITHUB_OUTPUT"
        # e.g. tag = v1.4.0

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh release create "${{ steps.version.outputs.tag }}" \
            --title "MacTuner ${{ steps.version.outputs.tag }}" \
            --generate-notes

      - name: Compute tarball SHA256
        id: sha
        run: |
          VERSION=${{ steps.version.outputs.tag }}
          URL="https://github.com/gfreedman/mac_tuner/archive/refs/tags/${VERSION}.tar.gz"
          SHA=$(curl -sL "$URL" | shasum -a 256 | awk '{print $1}')
          echo "sha256=${SHA}" >> "$GITHUB_OUTPUT"
          echo "url=${URL}" >> "$GITHUB_OUTPUT"
          echo "version=${VERSION#v}" >> "$GITHUB_OUTPUT"

      - name: Checkout homebrew-mactuner tap
        uses: actions/checkout@v4
        with:
          repository: gfreedman/homebrew-mactuner
          path: homebrew-mactuner
          token: ${{ secrets.HOMEBREW_TAP_TOKEN }}

      - name: Update formula
        working-directory: homebrew-mactuner
        run: |
          VERSION="${{ steps.sha.outputs.version }}"
          URL="${{ steps.sha.outputs.url }}"
          SHA="${{ steps.sha.outputs.sha256 }}"

          sed -i '' \
            -e "s|url \"https://github.com/gfreedman/mac_tuner/archive/refs/tags/v[^\"]*\"|url \"${URL}\"|" \
            -e "s|sha256 \"[a-f0-9]*\"|sha256 \"${SHA}\"|" \
            Formula/mactuner.rb

      - name: Commit and push formula update
        working-directory: homebrew-mactuner
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Formula/mactuner.rb
          git commit -m "mactuner ${{ steps.sha.outputs.version }}"
          git push
