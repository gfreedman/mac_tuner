"""
Virus protection and malware detection checks.

Covers ClamAV antivirus, Objective-See security tools, and persistence
location enumeration.  All checks are read-only â€” no scanning, no
execution of security tools.
"""

import shutil
import time
from pathlib import Path

from macaudit.checks.base import BaseCheck, CheckResult

HOME = Path.home()

# ClamAV binary locations (Apple Silicon Homebrew, Intel Homebrew, fallback)
_CLAMAV_BINARY_PATHS = [
    Path("/opt/homebrew/bin/clamscan"),
    Path("/usr/local/bin/clamscan"),
    Path("/usr/bin/clamscan"),
]

# ClamAV signature directories (.cvd / .cld files live here)
_CLAMAV_SIG_DIRS = [
    Path("/opt/homebrew/share/clamav"),
    Path("/usr/local/share/clamav"),
    Path("/var/lib/clamav"),
]

# freshclam configuration files â€” existence means auto-updates are configured
_FRESHCLAM_CONFIGS = [
    Path("/opt/homebrew/etc/clamav/freshclam.conf"),
    Path("/usr/local/etc/clamav/freshclam.conf"),
    Path("/etc/clamav/freshclam.conf"),
]

# Objective-See tools to look for in /Applications
_OBJECTIVE_SEE_TOOLS = [
    (Path("/Applications/LuLu.app"), "LuLu"),
    (Path("/Applications/BlockBlock Helper.app"), "BlockBlock"),
    (Path("/Applications/KnockKnock.app"), "KnockKnock"),
    (Path("/Applications/RansomWhere.app"), "RansomWhere"),
]

# Persistence directories to enumerate (read-only)
_PERSISTENCE_DIRS = [
    HOME / "Library" / "LaunchAgents",
    Path("/Library/LaunchAgents"),
    Path("/Library/LaunchDaemons"),
]

# macOS built-in XProtect bundle path
_XPROTECT_BUNDLE = Path(
    "/Library/Apple/System/Library/CoreServices/XProtect.bundle"
)

_SIG_FRESHNESS_DAYS = 7


# â”€â”€ Checks â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€


class ClamAVCheck(BaseCheck):
    """Check for ClamAV installation, signature freshness, and freshclam config."""

    id = "clamav"
    name = "ClamAV"
    category = "malware"
    category_icon = "ðŸ¦ "

    scan_description = (
        "Checking for ClamAV open-source antivirus â€” verifying installation, "
        "signature database freshness, and automatic update configuration."
    )
    finding_explanation = (
        "ClamAV is the most widely deployed open-source antivirus engine. "
        "It scans files against a community-maintained signature database for "
        "malware, trojans, and phishing payloads. Signatures older than 7 days "
        "leave recently catalogued threats undetected. freshclam handles daily "
        "automatic updates â€” without it, signatures go stale silently. "
        "macOS includes XProtect as a baseline scanner, but it only covers "
        "known high-profile malware families and is not a substitute for "
        "dedicated antivirus coverage."
    )
    recommendation = (
        "Install ClamAV via Homebrew: brew install clamav. "
        "Then copy the sample config and fetch initial signatures: "
        "cp $(brew --prefix)/etc/clamav/freshclam.conf.sample "
        "$(brew --prefix)/etc/clamav/freshclam.conf && freshclam. "
        "Enable automatic daily updates: brew services start clamav"
    )
    fix_level = "instructions"
    fix_description = "Install ClamAV and configure automatic signature updates"
    fix_steps = [
        "Install: brew install clamav",
        "Configure: cp $(brew --prefix)/etc/clamav/freshclam.conf.sample $(brew --prefix)/etc/clamav/freshclam.conf",
        "Fetch initial signatures: freshclam",
        "Enable auto-updates: brew services start clamav",
    ]
    fix_reversible = True
    fix_time_estimate = "~10 minutes"

    def run(self) -> CheckResult:
        """Check for clamscan binary, signature age, and freshclam.conf presence."""
        clamscan_path = shutil.which("clamscan")
        if not clamscan_path:
            for p in _CLAMAV_BINARY_PATHS:
                if p.exists():
                    clamscan_path = str(p)
                    break

        if not clamscan_path:
            # No ClamAV â€” report whether macOS XProtect provides a baseline
            xprotect_present = _XPROTECT_BUNDLE.exists()
            if xprotect_present:
                return self._warning(
                    "No dedicated antivirus found â€” macOS XProtect provides a "
                    "baseline, but a dedicated tool offers broader coverage",
                    data={"clamav_installed": False, "xprotect_present": True},
                )
            return self._warning(
                "No antivirus software found and XProtect bundle not detected",
                data={"clamav_installed": False, "xprotect_present": False},
            )

        # ClamAV is installed â€” check signature freshness
        sig_age_days, sig_filename = self._newest_signature_age()
        freshclam_configured = any(c.exists() for c in _FRESHCLAM_CONFIGS)

        if sig_age_days is None:
            return self._warning(
                "ClamAV installed but no signature files (.cvd/.cld) found â€” "
                "run freshclam to download the initial database",
                data={
                    "clamav_installed": True,
                    "clamscan_path": clamscan_path,
                    "freshclam_configured": freshclam_configured,
                },
            )

        age_str = f"{sig_age_days} day{'s' if sig_age_days != 1 else ''} ago"
        update_note = (
            " (auto-updates on)" if freshclam_configured
            else " (configure freshclam for auto-updates)"
        )

        if sig_age_days > _SIG_FRESHNESS_DAYS:
            return self._warning(
                f"ClamAV signatures are {sig_age_days} days old â€” "
                "run freshclam to update",
                data={
                    "clamav_installed": True,
                    "clamscan_path": clamscan_path,
                    "sig_age_days": sig_age_days,
                    "freshclam_configured": freshclam_configured,
                },
            )

        return self._pass(
            f"ClamAV installed, signatures updated {age_str}{update_note}",
            data={
                "clamav_installed": True,
                "clamscan_path": clamscan_path,
                "sig_age_days": sig_age_days,
                "freshclam_configured": freshclam_configured,
            },
        )

    def _newest_signature_age(self) -> tuple[int | None, str | None]:
        """
        Find the most recently modified .cvd or .cld file across all known
        ClamAV signature directories.

        Returns (age_in_days, filename) or (None, None) if no files found.
        """
        newest_mtime: float | None = None
        newest_name: str | None = None

        for sig_dir in _CLAMAV_SIG_DIRS:
            if not sig_dir.exists():
                continue
            for pattern in ("*.cvd", "*.cld"):
                for sig_file in sig_dir.glob(pattern):
                    try:
                        mtime = sig_file.stat().st_mtime
                        if newest_mtime is None or mtime > newest_mtime:
                            newest_mtime = mtime
                            newest_name = sig_file.name
                    except OSError:
                        continue

        if newest_mtime is None:
            return None, None

        age_days = int((time.time() - newest_mtime) / 86400)
        return age_days, newest_name


class ObjectiveSeeCheck(BaseCheck):
    """Check whether any Objective-See security tools are installed."""

    id = "objective_see_tools"
    name = "Objective-See Tools"
    category = "malware"
    category_icon = "ðŸ¦ "

    scan_description = (
        "Checking for Objective-See open-source security tools â€” LuLu, "
        "BlockBlock, KnockKnock, and RansomWhere add real-time threat "
        "detection that macOS does not provide natively."
    )
    finding_explanation = (
        "Objective-See makes free, open-source security tools purpose-built "
        "for macOS. LuLu blocks unknown outgoing connections, catching malware "
        "attempting to call home. BlockBlock alerts whenever any process tries "
        "to install a persistence mechanism. KnockKnock inventories everything "
        "configured to run at startup. RansomWhere detects ransomware-style "
        "bulk file encryption before it can spread. These tools were created by "
        "ex-NSA researcher Patrick Wardle and are widely trusted in the macOS "
        "security community."
    )
    recommendation = (
        "Download free tools from objective-see.org. At minimum, LuLu "
        "(outbound firewall) and BlockBlock (persistence monitor) together "
        "significantly raise your detection baseline with minimal setup."
    )
    fix_level = "none"
    fix_description = "Download from objective-see.org (free, open-source)"
    fix_reversible = True
    fix_time_estimate = "~10 minutes"

    def run(self) -> CheckResult:
        """Check /Applications for LuLu, BlockBlock, KnockKnock, and RansomWhere."""
        found = [name for path, name in _OBJECTIVE_SEE_TOOLS if path.exists()]

        if found:
            n = len(found)
            return self._pass(
                f"{n} Objective-See tool{'s' if n != 1 else ''} installed: "
                f"{', '.join(found)}",
                data={"tools_installed": found},
            )

        return self._info(
            "No Objective-See tools installed â€” free tools add significant "
            "macOS-specific threat detection",
            data={"tools_checked": [name for _, name in _OBJECTIVE_SEE_TOOLS]},
        )


class PersistenceLocationsCheck(BaseCheck):
    """Enumerate .plist files in LaunchAgent and LaunchDaemon directories."""

    id = "persistence_locations"
    name = "Persistence Directories"
    category = "malware"
    category_icon = "ðŸ¦ "

    scan_description = (
        "Enumerating launch agent and daemon directories â€” these are the "
        "primary locations where both legitimate software and malware register "
        "processes that start automatically."
    )
    finding_explanation = (
        "LaunchAgents and LaunchDaemons directories contain .plist files that "
        "macOS uses to start processes automatically at login or boot. Every "
        "background app â€” cloud sync services, printer drivers, updaters â€” "
        "registers here. So does malware. Knowing what lives in these "
        "directories helps you spot unexpected entries early. Items listed "
        "here are not flagged as malicious; they are enumerated for your "
        "awareness. The security.py Launch Agents check flags suspicious "
        "entries separately."
    )
    recommendation = (
        "Periodically review ~/Library/LaunchAgents/, /Library/LaunchAgents/, "
        "and /Library/LaunchDaemons/. Research any .plist you don't recognise "
        "using its filename as a search term. KnockKnock (Objective-See) "
        "provides a deeper inventory with threat intelligence lookups."
    )
    fix_level = "none"
    fix_description = "Informational â€” review listed items for anything unexpected"
    fix_reversible = True
    fix_time_estimate = "~5 minutes"

    def run(self) -> CheckResult:
        """List .plist files in user and system LaunchAgent/Daemon directories."""
        items_by_dir: dict[str, list[str]] = {}
        total = 0

        for d in _PERSISTENCE_DIRS:
            if not d.exists():
                continue
            try:
                files = sorted(
                    f.name for f in d.iterdir()
                    if f.suffix == ".plist" and not f.name.startswith(".")
                )
            except PermissionError:
                files = ["(permission denied)"]

            if files:
                items_by_dir[str(d)] = files
                total += len(files)

        if not items_by_dir:
            return self._pass("Persistence directories are empty or absent")

        dir_names = [Path(d).name for d in items_by_dir]
        return self._info(
            f"{total} item{'s' if total != 1 else ''} across persistence "
            f"directories: {', '.join(dir_names)}",
            data={"persistence_items": items_by_dir, "total": total},
        )


# â”€â”€ Public list for main.py â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

ALL_CHECKS: list[type[BaseCheck]] = [
    ClamAVCheck,
    ObjectiveSeeCheck,
    PersistenceLocationsCheck,
]
